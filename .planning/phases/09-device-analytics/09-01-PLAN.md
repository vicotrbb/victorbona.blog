---
phase: 09-device-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/lib/device-detection.ts
  - app/lib/metrics.ts
  - middleware.ts
  - app/components/page-view-tracker.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Chrome browser visits show browser='chrome' in metrics"
    - "Safari on mobile shows browser='safari' and device='mobile' in metrics"
    - "Firefox on desktop shows browser='firefox' and device='desktop' in metrics"
    - "Unknown/bot user agents show browser='other' or 'unknown' without crashing"
  artifacts:
    - path: "app/lib/device-detection.ts"
      provides: "Browser/device detection from User-Agent"
      exports: ["detectBrowserAndDevice"]
    - path: "app/lib/metrics.ts"
      provides: "Extended pageViewsCounter with browser/device labels"
      contains: "'browser', 'device'"
    - path: "middleware.ts"
      provides: "Browser/device extraction and header setting"
      contains: "x-metrics-browser"
    - path: "app/components/page-view-tracker.tsx"
      provides: "Browser/device header reading and counter increment"
      contains: "browser, device"
  key_links:
    - from: "middleware.ts"
      to: "app/lib/device-detection.ts"
      via: "import detectBrowserAndDevice"
      pattern: "import.*detectBrowserAndDevice.*device-detection"
    - from: "middleware.ts"
      to: "PageViewTracker"
      via: "x-metrics-browser/x-metrics-device headers"
      pattern: "x-metrics-browser"
    - from: "app/components/page-view-tracker.tsx"
      to: "app/lib/metrics.ts"
      via: "pageViewsCounter.inc with browser/device labels"
      pattern: "browser.*device"
---

<objective>
Extend page view metrics with browser family and device category detection using the bowser library.

Purpose: Enable browser/device analytics in Grafana dashboard (Phase 10) to understand visitor distribution across platforms.

Output:
- `app/lib/device-detection.ts` - Browser/device parsing utility
- Extended `blog_page_views_total` metric with `browser` and `device` labels
- Middleware wired to extract and pass browser/device data via headers
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-device-analytics/09-RESEARCH.md

# Existing code to extend
@middleware.ts
@app/lib/metrics.ts
@app/components/page-view-tracker.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install bowser and create device-detection.ts</name>
  <files>
    package.json
    app/lib/device-detection.ts
  </files>
  <action>
1. Install bowser library:
   ```bash
   npm install bowser
   ```

2. Create `app/lib/device-detection.ts` with:
   - Import Bowser from 'bowser'
   - BROWSER_NORMALIZATION map for major browsers (chrome, firefox, safari, edge, opera, samsung, vivaldi, brave, ie) -> normalized name
   - Chromium variants (chromium) map to 'chrome'
   - Firefox variants (librewolf, pale moon) map to 'firefox'
   - Mobile Safari maps to 'safari'
   - Everything else maps to 'other'

   - Export function `detectBrowserAndDevice(userAgent: string | null): { browser: string; device: string }`
   - Handle empty/null User-Agent -> return { browser: 'unknown', device: 'unknown' }
   - Wrap Bowser.getParser() in try/catch for malformed UA strings
   - Extract browser name via parser.getBrowserName()
   - Normalize browser name via BROWSER_NORMALIZATION map or 'other' if not found
   - Extract device via parser.getPlatformType() which returns 'desktop', 'mobile', 'tablet', 'tv', or undefined
   - Return undefined platform as 'unknown'

3. All string values should be lowercase for consistency with Phase 7/8 patterns.
  </action>
  <verify>
   - `npm run build` passes (TypeScript compiles)
   - bowser appears in package.json dependencies
   - app/lib/device-detection.ts exports detectBrowserAndDevice function
  </verify>
  <done>
   - bowser installed
   - device-detection.ts created with detectBrowserAndDevice function
   - Function handles edge cases (null UA, malformed UA, unknown browsers)
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend metrics.ts with browser and device labels</name>
  <files>
    app/lib/metrics.ts
  </files>
  <action>
1. In `app/lib/metrics.ts`:
   - Add 'browser' and 'device' to pageViewsLabelNames array (after 'utm_medium')
   - Add comments:
     - browser: "Browser family (chrome, firefox, safari, edge, opera, samsung, other, unknown)"
     - device: "Device category (desktop, mobile, tablet, tv, unknown)"
   - Update help string for blog_page_views_total to include browser and device

Note: This is a breaking change to the metric - the counter signature changes. In development this may require clearing metrics state (restart dev server).
  </action>
  <verify>
   - `npm run build` passes
   - pageViewsLabelNames includes 'browser' and 'device' (grep for confirmation)
  </verify>
  <done>
   - pageViewsCounter now expects browser and device labels
   - Labels documented with allowed values in comments
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire middleware and PageViewTracker with browser/device data</name>
  <files>
    middleware.ts
    app/components/page-view-tracker.tsx
  </files>
  <action>
1. In `middleware.ts`:
   - Import detectBrowserAndDevice from './app/lib/device-detection'
   - After existing isBot detection, extract browser/device:
     ```typescript
     const { browser, device } = detectBrowserAndDevice(userAgent)
     ```
   - Set headers:
     ```typescript
     requestHeaders.set('x-metrics-browser', browser)
     requestHeaders.set('x-metrics-device', device)
     ```

2. In `app/components/page-view-tracker.tsx`:
   - Read new headers:
     ```typescript
     const browser = headersList.get('x-metrics-browser') || 'unknown'
     const device = headersList.get('x-metrics-device') || 'unknown'
     ```
   - Add browser and device to pageViewsCounter.inc() call:
     ```typescript
     pageViewsCounter.inc({
       path,
       method,
       is_bot: isBot,
       content_type: contentType,
       source,
       utm_source: utmSource,
       utm_medium: utmMedium,
       browser,
       device,
     })
     ```
  </action>
  <verify>
1. Build passes: `npm run build`
2. Start dev server and test with curl:
   - Chrome UA: `curl -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36" http://localhost:3000/`
   - Safari mobile UA: `curl -H "User-Agent: Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1" http://localhost:3000/`
   - Firefox desktop UA: `curl -H "User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0" http://localhost:3000/`
   - No UA: `curl http://localhost:3000/`
3. Check /metrics endpoint shows browser and device labels:
   - `curl http://localhost:3000/metrics | grep blog_page_views_total`
   - Should show entries with browser="chrome" device="desktop", browser="safari" device="mobile", etc.
  </verify>
  <done>
   - Chrome visits show browser="chrome" in metrics
   - Safari mobile visits show browser="safari" device="mobile" in metrics
   - Firefox desktop visits show browser="firefox" device="desktop" in metrics
   - Missing/unknown UA shows browser="unknown" device="unknown" (no crashes)
   - Build passes
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:** `npm run build` passes without errors

2. **Metrics endpoint verification:**
   ```bash
   curl http://localhost:3000/metrics | grep blog_page_views_total
   ```
   Should show browser and device labels on all page view metrics.

3. **Browser detection verification:**
   - Chrome: browser="chrome"
   - Firefox: browser="firefox"
   - Safari: browser="safari"
   - Edge: browser="edge"
   - Unknown: browser="other" or "unknown"

4. **Device detection verification:**
   - Desktop browsers: device="desktop"
   - iPhone/Android phones: device="mobile"
   - iPad/Android tablets: device="tablet"
   - Unknown: device="unknown"

5. **Requirements check:**
   - DEVICE-01: Browser family identified - VERIFIED
   - DEVICE-02: Platform category identified - VERIFIED
</verification>

<success_criteria>
- [x] bowser library installed and listed in package.json
- [x] app/lib/device-detection.ts exports detectBrowserAndDevice function
- [x] blog_page_views_total counter has browser and device labels
- [x] Middleware extracts browser/device and sets x-metrics-browser/x-metrics-device headers
- [x] PageViewTracker reads headers and passes browser/device to counter
- [x] Chrome browser visits show browser="chrome" in /metrics
- [x] Safari on iPhone shows browser="safari" and device="mobile" in /metrics
- [x] Firefox on desktop shows browser="firefox" and device="desktop" in /metrics
- [x] Unknown/empty User-Agent shows browser="unknown" without crashing
- [x] npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-device-analytics/09-01-SUMMARY.md` following the summary template.

Update `.planning/STATE.md`:
- Current position: Phase 9 of 10 complete
- Add decision about browser normalization approach
- Progress: 75% (3/4 v1.1 phases complete)
</output>
