---
phase: 08-traffic-source-attribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/lib/source-detection.ts
  - app/lib/utm-parser.ts
  - app/lib/metrics.ts
  - middleware.ts
  - app/components/page-view-tracker.tsx
autonomous: true

must_haves:
  truths:
    - "Visit from Google search shows source='google' in blog_page_views_total metric"
    - "Visit from Twitter/X link shows source='twitter' in blog_page_views_total metric"
    - "Direct visits (no referrer) show source='direct' in blog_page_views_total metric"
    - "Internal navigation (own domain) shows source='direct' in blog_page_views_total metric"
    - "URLs with ?utm_source=newsletter show utm_source='newsletter' in metric"
    - "URLs with ?utm_medium=email show utm_medium='email' in metric"
    - "Unknown referrer domains appear as-is in source label (e.g., source='example.com')"
  artifacts:
    - path: "app/lib/source-detection.ts"
      provides: "detectSource function with domain-to-source mapping"
      exports: ["detectSource"]
    - path: "app/lib/utm-parser.ts"
      provides: "extractUtmParams function with validation"
      exports: ["extractUtmParams"]
    - path: "app/lib/metrics.ts"
      provides: "pageViewsCounter with extended labels including source, utm_source, utm_medium"
      exports: ["pageViewsCounter"]
    - path: "middleware.ts"
      provides: "x-metrics-source, x-metrics-utm-source, x-metrics-utm-medium headers"
      contains: "detectSource"
    - path: "app/components/page-view-tracker.tsx"
      provides: "Reads new headers and passes to counter"
      contains: "source"
  key_links:
    - from: "middleware.ts"
      to: "app/lib/source-detection.ts"
      via: "import detectSource"
      pattern: "import.*detectSource.*from.*source-detection"
    - from: "middleware.ts"
      to: "app/lib/utm-parser.ts"
      via: "import extractUtmParams"
      pattern: "import.*extractUtmParams.*from.*utm-parser"
    - from: "app/components/page-view-tracker.tsx"
      to: "app/lib/metrics.ts"
      via: "pageViewsCounter.inc with source labels"
      pattern: "pageViewsCounter\\.inc.*source"
---

<objective>
Implement traffic source attribution by parsing referrer headers and UTM parameters, extending the existing page view metrics.

Purpose: Track where visitors come from (search engines, social platforms, direct, campaigns) for blog analytics
Output: Extended blog_page_views_total metric with source, utm_source, and utm_medium labels
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-traffic-source-attribution/08-RESEARCH.md
@.planning/phases/07-page-view-metrics/07-01-SUMMARY.md
@app/lib/metrics.ts
@middleware.ts
@app/components/page-view-tracker.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create source detection and UTM parsing utilities</name>
  <files>app/lib/source-detection.ts, app/lib/utm-parser.ts</files>
  <action>
Create two utility files following the patterns from 08-RESEARCH.md:

**1. app/lib/source-detection.ts:**

```typescript
const OWN_DOMAINS = ['blog.victorbona.dev', 'victorbona.dev']

const SEARCH_ENGINE_DOMAINS: Record<string, string> = {
  'google.com': 'google',
  'www.google.com': 'google',
  'google.co.uk': 'google',
  'google.ca': 'google',
  'google.de': 'google',
  'google.fr': 'google',
  'google.com.au': 'google',
  'google.co.jp': 'google',
  'google.com.br': 'google',
  'bing.com': 'bing',
  'www.bing.com': 'bing',
  'm.bing.com': 'bing',
  'duckduckgo.com': 'duckduckgo',
  'search.yahoo.com': 'yahoo',
  'yahoo.com': 'yahoo',
  'baidu.com': 'baidu',
  'www.baidu.com': 'baidu',
  'm.baidu.com': 'baidu',
  'yandex.com': 'yandex',
  'yandex.ru': 'yandex',
  'ecosia.org': 'ecosia',
  'www.ecosia.org': 'ecosia',
  'search.brave.com': 'brave',
  'startpage.com': 'startpage',
  'www.startpage.com': 'startpage',
}

const SOCIAL_DOMAINS: Record<string, string> = {
  'twitter.com': 'twitter',
  'www.twitter.com': 'twitter',
  'mobile.twitter.com': 'twitter',
  'x.com': 'twitter',
  't.co': 'twitter',
  'facebook.com': 'facebook',
  'www.facebook.com': 'facebook',
  'm.facebook.com': 'facebook',
  'l.facebook.com': 'facebook',
  'lm.facebook.com': 'facebook',
  'linkedin.com': 'linkedin',
  'www.linkedin.com': 'linkedin',
  'lnkd.in': 'linkedin',
  'reddit.com': 'reddit',
  'www.reddit.com': 'reddit',
  'old.reddit.com': 'reddit',
  'instagram.com': 'instagram',
  'www.instagram.com': 'instagram',
  'l.instagram.com': 'instagram',
  'youtube.com': 'youtube',
  'www.youtube.com': 'youtube',
  'm.youtube.com': 'youtube',
  'youtu.be': 'youtube',
  'pinterest.com': 'pinterest',
  'www.pinterest.com': 'pinterest',
  'tiktok.com': 'tiktok',
  'www.tiktok.com': 'tiktok',
  'news.ycombinator.com': 'hackernews',
  'mastodon.social': 'mastodon',
  'threads.net': 'threads',
  'www.threads.net': 'threads',
}

export function detectSource(referer: string | null): string {
  // No referer = direct traffic
  if (!referer) {
    return 'direct'
  }

  // Parse the referer URL
  let hostname: string
  try {
    const url = new URL(referer)
    hostname = url.hostname.toLowerCase()
  } catch {
    // Invalid URL = treat as direct
    return 'direct'
  }

  // Self-referral = direct
  if (OWN_DOMAINS.some(domain => hostname === domain || hostname.endsWith('.' + domain))) {
    return 'direct'
  }

  // Check search engines
  const searchSource = SEARCH_ENGINE_DOMAINS[hostname]
  if (searchSource) {
    return searchSource
  }

  // Check social platforms
  const socialSource = SOCIAL_DOMAINS[hostname]
  if (socialSource) {
    return socialSource
  }

  // Unknown referrer = return the hostname as-is (referral traffic)
  return hostname
}
```

**2. app/lib/utm-parser.ts:**

```typescript
const UTM_MAX_LENGTH = 50
const UTM_ALLOWED_PATTERN = /^[a-z0-9_-]*$/

function validateUtmValue(value: string | null): string {
  if (!value) return ''

  // Normalize to lowercase
  const normalized = value.toLowerCase()

  // Check length
  if (normalized.length > UTM_MAX_LENGTH) return ''

  // Check allowed characters (alphanumeric, underscores, hyphens only)
  if (!UTM_ALLOWED_PATTERN.test(normalized)) return ''

  return normalized
}

export function extractUtmParams(searchParams: URLSearchParams): {
  utmSource: string
  utmMedium: string
} {
  return {
    utmSource: validateUtmValue(searchParams.get('utm_source')),
    utmMedium: validateUtmValue(searchParams.get('utm_medium')),
  }
}
```

Key implementation notes:
- detectSource handles null/empty referer, invalid URLs, and self-referral
- All comparisons use lowercase for consistency
- Unknown domains return as-is (not "referral" category) per RESEARCH.md
- UTM validation prevents cardinality explosion from malicious values
  </action>
  <verify>
Run `npm run build` - no TypeScript errors.
Check that files exist: `ls app/lib/source-detection.ts app/lib/utm-parser.ts`
  </verify>
  <done>
Two utility files created with exported functions: detectSource and extractUtmParams
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend metrics.ts with source and UTM labels</name>
  <files>app/lib/metrics.ts</files>
  <action>
Modify the pageViewsCounter in app/lib/metrics.ts to include the new labels.

**CRITICAL:** prom-client counters cannot have new labels added after creation. You must update the labelNames array to include the new labels. The existing counter definition will be replaced with extended labels.

**Changes to make:**

1. Update pageViewsLabelNames to include source, utm_source, utm_medium:

```typescript
const pageViewsLabelNames = [
  'path',
  'method',
  'is_bot',
  'content_type',
  'source',      // NEW: referrer source (google, twitter, direct, etc.)
  'utm_source',  // NEW: UTM campaign source
  'utm_medium',  // NEW: UTM campaign medium
] as const
```

2. Update the help text for pageViewsCounter:

```typescript
function initializePageViewsCounter(): Counter {
  return new Counter({
    name: 'blog_page_views_total',
    help: 'Total page views by path, method, bot status, content type, source, and UTM parameters',
    labelNames: pageViewsLabelNames,
    registers: [metricsRegistry],
  })
}
```

**Important:** The globalThis singleton pattern remains the same. Only the labelNames array and help text change.

Note: After this change, any .inc() calls must provide all labels including source, utm_source, utm_medium.
  </action>
  <verify>
Run `npm run build` - no TypeScript errors.
Grep for labelNames to confirm new labels: `grep -A10 "pageViewsLabelNames" app/lib/metrics.ts`
  </verify>
  <done>
pageViewsCounter now has source, utm_source, and utm_medium in its labelNames array.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire middleware and PageViewTracker with source/UTM data</name>
  <files>middleware.ts, app/components/page-view-tracker.tsx</files>
  <action>
**1. Update middleware.ts:**

Add imports at the top:
```typescript
import { detectSource } from './app/lib/source-detection'
import { extractUtmParams } from './app/lib/utm-parser'
```

In the middleware function, after the existing header setup but before NextResponse.next():

```typescript
// Extract referrer source
const referer = request.headers.get('referer')
const source = detectSource(referer)

// Extract UTM parameters from URL
const { utmSource, utmMedium } = extractUtmParams(request.nextUrl.searchParams)

// Add new metrics headers
requestHeaders.set('x-metrics-source', source)
requestHeaders.set('x-metrics-utm-source', utmSource)
requestHeaders.set('x-metrics-utm-medium', utmMedium)
```

**2. Update app/components/page-view-tracker.tsx:**

Read the new headers:
```typescript
const source = headersList.get('x-metrics-source') || 'direct'
const utmSource = headersList.get('x-metrics-utm-source') || ''
const utmMedium = headersList.get('x-metrics-utm-medium') || ''
```

Update the pageViewsCounter.inc() call to include all labels:
```typescript
pageViewsCounter.inc({
  path,
  method,
  is_bot: isBot,
  content_type: contentType,
  source,
  utm_source: utmSource,
  utm_medium: utmMedium,
})
```

**Important:** All three new labels must be present in every .inc() call. Use empty string '' for missing UTM values (not undefined).
  </action>
  <verify>
Run `npm run dev`, then test in separate terminal:

1. Direct visit (no referrer):
```bash
curl -s http://localhost:3000/ | head -1
curl -s http://localhost:3000/metrics | grep 'blog_page_views_total.*source="direct"'
```

2. Referrer from Google:
```bash
curl -s -H 'Referer: https://www.google.com/search?q=test' http://localhost:3000/blog
curl -s http://localhost:3000/metrics | grep 'blog_page_views_total.*source="google"'
```

3. UTM parameters:
```bash
curl -s 'http://localhost:3000/?utm_source=newsletter&utm_medium=email'
curl -s http://localhost:3000/metrics | grep 'blog_page_views_total.*utm_source="newsletter".*utm_medium="email"'
```

4. Twitter referrer:
```bash
curl -s -H 'Referer: https://t.co/abc123' http://localhost:3000/blog
curl -s http://localhost:3000/metrics | grep 'blog_page_views_total.*source="twitter"'
```

5. Build passes: `npm run build`
  </verify>
  <done>
Middleware extracts source and UTM params, sets headers. PageViewTracker reads headers and passes all labels to counter.
  </done>
</task>

</tasks>

<verification>
1. Start dev server: `npm run dev`
2. Test direct traffic (curl without Referer header):
   - `curl -s http://localhost:3000/`
   - Check /metrics: should see `source="direct"`
3. Test Google referrer:
   - `curl -s -H 'Referer: https://www.google.com/' http://localhost:3000/blog`
   - Check /metrics: should see `source="google"`
4. Test Twitter referrer (t.co shortener):
   - `curl -s -H 'Referer: https://t.co/xyz' http://localhost:3000/`
   - Check /metrics: should see `source="twitter"`
5. Test UTM parameters:
   - `curl -s 'http://localhost:3000/?utm_source=newsletter&utm_medium=email'`
   - Check /metrics: should see `utm_source="newsletter"` and `utm_medium="email"`
6. Test unknown referrer:
   - `curl -s -H 'Referer: https://someunknown.site/page' http://localhost:3000/`
   - Check /metrics: should see `source="someunknown.site"`
7. Test internal navigation (self-referral):
   - `curl -s -H 'Referer: https://blog.victorbona.dev/about' http://localhost:3000/`
   - Check /metrics: should see `source="direct"` (self-referral treated as direct)
8. Run `npm run build` - no errors
</verification>

<success_criteria>
- [ ] blog_page_views_total has source label visible at /metrics
- [ ] blog_page_views_total has utm_source and utm_medium labels visible at /metrics
- [ ] Google referrer shows source="google"
- [ ] Bing referrer shows source="bing"
- [ ] Twitter/t.co referrer shows source="twitter"
- [ ] Facebook referrer shows source="facebook"
- [ ] LinkedIn referrer shows source="linkedin"
- [ ] Reddit referrer shows source="reddit"
- [ ] Hacker News referrer shows source="hackernews"
- [ ] Direct visits (no referrer) show source="direct"
- [ ] Self-referral (from own domain) shows source="direct"
- [ ] Unknown referrer domains appear as-is in source label
- [ ] UTM source parameter captured in utm_source label
- [ ] UTM medium parameter captured in utm_medium label
- [ ] Invalid/malicious UTM values rejected (empty string instead)
- [ ] Build passes: npm run build
</success_criteria>

<output>
After completion, create `.planning/phases/08-traffic-source-attribution/08-01-SUMMARY.md`
</output>
