---
phase: 02-ci-cd-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/build.yml
autonomous: true

must_haves:
  truths:
    - "Pushing to main triggers a Docker build"
    - "Both amd64 and arm64 images are built"
    - "Images are pushed to ghcr.io/vicotrbb/victorbona.blog"
    - "Images are tagged with short SHA and latest"
    - "Non-code changes (docs, .planning) do not trigger builds"
  artifacts:
    - path: ".github/workflows/build.yml"
      provides: "GitHub Actions workflow for Docker builds"
      min_lines: 50
      contains: "build-push-action"
  key_links:
    - from: ".github/workflows/build.yml"
      to: "ghcr.io"
      via: "docker/login-action with GITHUB_TOKEN"
      pattern: "docker/login-action"
    - from: ".github/workflows/build.yml"
      to: "Dockerfile"
      via: "docker/build-push-action with context: ."
      pattern: "context:\\s*\\."
---

<objective>
Create a GitHub Actions workflow that automatically builds and pushes multi-architecture Docker images to GHCR on main branch pushes.

Purpose: Automate the container build process established in Phase 1, enabling continuous delivery to the container registry.

Output: `.github/workflows/build.yml` with multi-arch builds, automatic tagging, and GHCR push.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ci-cd-pipeline/02-CONTEXT.md
@.planning/phases/02-ci-cd-pipeline/02-RESEARCH.md
@Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions workflow</name>
  <files>.github/workflows/build.yml</files>
  <action>
Create the GitHub Actions workflow file with the following structure:

**Trigger configuration:**
- on.push.branches: [main]
- on.push.paths-ignore: ['docs/**', '*.md', '.planning/**']
- on.workflow_dispatch (for manual triggers)

**Permissions:**
- contents: read
- packages: write

**Job steps (in order):**
1. actions/checkout@v5
2. docker/setup-qemu-action@v3 (for arm64 emulation)
3. docker/setup-buildx-action@v3 (for multi-platform builds)
4. docker/login-action@v3 with:
   - registry: ghcr.io
   - username: ${{ github.actor }}
   - password: ${{ secrets.GITHUB_TOKEN }}
5. docker/metadata-action@v5 with:
   - images: ghcr.io/${{ github.repository }}
   - tags: type=sha,prefix= AND type=raw,value=latest,enable={{is_default_branch}}
6. docker/build-push-action@v6 with:
   - context: . (REQUIRED - do not omit)
   - platforms: linux/amd64,linux/arm64
   - push: true
   - tags: ${{ steps.meta.outputs.tags }}
   - labels: ${{ steps.meta.outputs.labels }}
   - cache-from: type=gha
   - cache-to: type=gha,mode=max

**Critical details from CONTEXT.md:**
- No SBOM or attestation (keep it simple)
- No automatic retries
- Single job (no matrix) for atomic multi-arch push

**Critical details from RESEARCH.md:**
- Always specify context: . explicitly (avoids build context issues)
- metadata-action id must be 'meta' to reference outputs
- GITHUB_TOKEN works for GHCR without additional setup
  </action>
  <verify>
Verify workflow syntax:
- YAML is valid (no syntax errors)
- All required fields present (on, permissions, jobs, steps)
- Action versions match research (v3/v5/v6)
- context: . is explicitly set
- platforms includes both amd64 and arm64
  </verify>
  <done>
.github/workflows/build.yml exists with:
- Triggers on main branch push (excluding docs/md/.planning)
- All 6 steps configured correctly
- Multi-arch build (amd64 + arm64)
- GHCR authentication via GITHUB_TOKEN
- Tags with SHA and latest
- GHA caching enabled
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
GitHub Actions workflow for Docker multi-arch builds with GHCR push.
  </what-built>
  <how-to-verify>
The workflow is now committed. To verify it works:

1. **Check workflow appears in GitHub:**
   - Go to https://github.com/vicotrbb/victorbona.blog/actions
   - You should see "Build and Push Docker Image" workflow

2. **Trigger a build (choose one):**
   - Push any code change to main branch, OR
   - Click "Run workflow" button in Actions tab (workflow_dispatch)

3. **Verify the build:**
   - Build should complete successfully (green checkmark)
   - Both amd64 and arm64 platforms should be built
   - Check build logs for "Pushing manifest" or similar

4. **Verify images in GHCR:**
   - Go to https://github.com/vicotrbb/victorbona.blog/pkgs/container/victorbona.blog
   - Should see image with SHA tag (e.g., abc1234) and :latest tag
   - Click on a tag to verify it shows OS/Arch: linux/amd64 and linux/arm64

5. **Verify path filtering:**
   - A change ONLY to .planning/ or *.md files should NOT trigger a build
  </how-to-verify>
  <resume-signal>Type "verified" after confirming the build works, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase verification checklist:
- [ ] Workflow file exists at .github/workflows/build.yml
- [ ] GitHub Actions shows the workflow
- [ ] Manual or push-triggered build succeeds
- [ ] Images appear in GHCR with correct tags
- [ ] Multi-arch manifest contains both amd64 and arm64
</verification>

<success_criteria>
Phase 2 is complete when:
1. GitHub Actions workflow builds Docker images on main branch push
2. Both amd64 and arm64 architectures are built
3. Images are pushed to ghcr.io/vicotrbb/victorbona.blog
4. Images are tagged with git SHA and :latest
5. GHA caching is configured for faster subsequent builds
</success_criteria>

<output>
After completion, create `.planning/phases/02-ci-cd-pipeline/02-01-SUMMARY.md`
</output>
