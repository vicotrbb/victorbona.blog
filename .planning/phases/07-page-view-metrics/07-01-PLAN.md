---
phase: 07-page-view-metrics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/lib/metrics.ts
  - middleware.ts
  - app/not-found.tsx
autonomous: true

must_haves:
  truths:
    - "Visiting /blog/any-post increments blog_page_views_total counter"
    - "Visiting /articles/any-article increments blog_page_views_total counter"
    - "404 errors increment blog_http_requests_total with status_code=404"
    - "/metrics endpoint shows blog_page_views_total and blog_http_requests_total"
    - "Bot traffic labeled with is_bot=true in metrics"
  artifacts:
    - path: "app/lib/metrics.ts"
      provides: "Counter and Histogram metric definitions"
      exports: ["metricsRegistry", "pageViewsCounter", "httpRequestsCounter", "pageDurationHistogram"]
    - path: "middleware.ts"
      provides: "Request interception with path normalization and bot detection"
      contains: "pageViewsCounter.inc"
    - path: "app/not-found.tsx"
      provides: "404 tracking in httpRequestsCounter"
      contains: "httpRequestsCounter.inc"
  key_links:
    - from: "middleware.ts"
      to: "app/lib/metrics.ts"
      via: "import counters and histogram"
      pattern: "import.*from.*metrics"
    - from: "app/not-found.tsx"
      to: "app/lib/metrics.ts"
      via: "import httpRequestsCounter"
      pattern: "import.*httpRequestsCounter"
    - from: "app/metrics/route.ts"
      to: "app/lib/metrics.ts"
      via: "metricsRegistry.metrics() exposes all counters"
      pattern: "metricsRegistry\\.metrics"
---

<objective>
Implement server-side page view metrics with path normalization and request metadata.

Purpose: Track page views, request counts by status code, and request duration for blog analytics
Output: Working middleware that increments Prometheus counters, visible at /metrics endpoint
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-page-view-metrics/07-CONTEXT.md
@.planning/phases/07-page-view-metrics/07-RESEARCH.md
@app/lib/metrics.ts
@app/metrics/route.ts
@app/not-found.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend metrics.ts with Counter and Histogram definitions</name>
  <files>app/lib/metrics.ts</files>
  <action>
Extend the existing metrics.ts to add three new metrics using the established globalThis singleton pattern:

1. **blog_page_views_total** Counter:
   - Labels: `path`, `method`, `is_bot`
   - Help: "Total page views by path, method, and bot status"

2. **blog_http_requests_total** Counter:
   - Labels: `path`, `method`, `status_code`
   - Help: "Total HTTP requests by path, method, and status code"

3. **blog_page_duration_seconds** Histogram:
   - Labels: `path`, `method`
   - Help: "Page request duration in seconds"
   - Buckets: `[0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5]` (web-optimized)

Each metric needs:
- globalThis declaration (`var pageViewsCounter: Counter | undefined`)
- Initialization function that creates the metric with the registry
- Export via singleton pattern

Use `as const` for labelNames to get TypeScript type safety.

Keep the existing metricsRegistry and collectDefaultMetrics code unchanged.
  </action>
  <verify>
Run `npm run build` - no TypeScript errors.
Check that exports are available: `pageViewsCounter`, `httpRequestsCounter`, `pageDurationHistogram`.
  </verify>
  <done>
metrics.ts exports three new metrics (Counter, Counter, Histogram) alongside existing metricsRegistry.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create middleware.ts for request interception</name>
  <files>middleware.ts</files>
  <action>
Create `middleware.ts` at project root (not in app/ directory).

**Install isbot first:**
```bash
npm install isbot
```

**Middleware implementation:**

1. Import from `./app/lib/metrics`:
   - `pageViewsCounter`
   - `pageDurationHistogram`

   Note: If Edge runtime import fails, may need to configure middleware for Node.js runtime. Try default first.

2. Define exclusion patterns (do NOT track these):
   - `/_next/*` (Next.js internals)
   - `/api/*` (API routes)
   - `/metrics` (metrics endpoint)
   - `/health`, `/api/health`, `/api/ready` (health checks)
   - Static assets: `.js`, `.css`, `.ico`, `.png`, `.jpg`, `.jpeg`, `.gif`, `.svg`, `.woff`, `.woff2`, `.ttf`, `.eot`

3. Path normalization function:
   - Remove trailing slash (except for root `/`)
   - Lowercase
   - Query params already stripped by `pathname`

4. Main middleware function:
   - Skip excluded paths (return `NextResponse.next()`)
   - Start timer with `performance.now()`
   - Get normalized path, method, user-agent
   - Detect bot using `isbot(userAgent)`
   - Increment `pageViewsCounter` with labels: `{ path, method, is_bot: 'true'|'false' }`
   - Create response via `NextResponse.next()`
   - Observe duration in `pageDurationHistogram`
   - Return response

5. Export config with matcher:
```typescript
export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico).*)'],
}
```

**Important per CONTEXT.md:**
- Keep actual slugs in path labels (do NOT normalize to `:slug`)
- Label bot traffic, don't exclude it
  </action>
  <verify>
Run `npm run dev`, visit http://localhost:3000/blog.
Check http://localhost:3000/metrics for `blog_page_views_total` with path="/blog".
Visit a non-existent page, middleware should still count the page view.
  </verify>
  <done>
Middleware intercepts requests, increments page view counter with path/method/is_bot labels, records duration histogram.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update not-found.tsx to track 404s</name>
  <files>app/not-found.tsx</files>
  <action>
Update `app/not-found.tsx` to increment the httpRequestsCounter when rendered.

**Implementation:**

1. Import `httpRequestsCounter` from `./lib/metrics`
2. Import `headers` from `next/headers` to get the requested path
3. At the top of the component (server-side render), increment counter:
   ```typescript
   httpRequestsCounter.inc({
     path: headersList.get('x-url') || 'not_found',  // or use pathname from headers
     method: 'GET',
     status_code: '404',
   })
   ```

**Note:** Getting the actual path in not-found.tsx is tricky. Options:
- Use `headers()` to try to get referer or custom header
- If path unavailable, use generic `'not_found'` as path label (acceptable per CONTEXT.md which says "keep actual path for 404s to see what URLs are being hit")
- Consider: middleware already tracked the path; this just adds the status_code dimension

**Simpler approach:** Since middleware already incremented page view, the 404 counter just needs to record that a 404 happened. Use pathname from request if available, otherwise use `'unknown'`. The key is the `status_code: '404'` label.

Keep existing JSX unchanged.
  </action>
  <verify>
Visit http://localhost:3000/nonexistent-page-12345
Check http://localhost:3000/metrics for `blog_http_requests_total{...status_code="404"...}`.
  </verify>
  <done>
404 page increments httpRequestsCounter with status_code="404" label.
  </done>
</task>

</tasks>

<verification>
1. Start dev server: `npm run dev`
2. Visit http://localhost:3000/blog - should work normally
3. Visit http://localhost:3000/articles - should work normally
4. Visit http://localhost:3000/nonexistent - should show 404 page
5. Check http://localhost:3000/metrics - should show:
   - `blog_page_views_total{path="/blog",method="GET",is_bot="false"} 1`
   - `blog_page_views_total{path="/articles",method="GET",is_bot="false"} 1`
   - `blog_http_requests_total{...status_code="404"...}` with at least 1 count
   - `blog_page_duration_seconds_bucket{...}` histogram buckets
6. Run `npm run build` - no errors
</verification>

<success_criteria>
- [ ] blog_page_views_total counter visible at /metrics with path, method, is_bot labels
- [ ] blog_http_requests_total counter visible at /metrics with path, method, status_code labels
- [ ] blog_page_duration_seconds histogram visible at /metrics
- [ ] Visiting /blog/any-post increments counter with actual path (not normalized to :slug)
- [ ] 404 errors tracked with status_code="404"
- [ ] Bot traffic labeled with is_bot="true" (test with curl which is detected as bot)
- [ ] Static assets (/_next/*, .js, .css) NOT counted in page views
</success_criteria>

<output>
After completion, create `.planning/phases/07-page-view-metrics/07-01-SUMMARY.md`
</output>
