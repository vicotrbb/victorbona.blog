---
phase: 10-grafana-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - chart/files/dashboards/blog-analytics.json
  - chart/templates/grafana-dashboard.yaml
  - chart/values.yaml
autonomous: true

must_haves:
  truths:
    - "Dashboard appears in Grafana without manual import"
    - "Page views over time graph shows real Prometheus data"
    - "Top pages panel shows most viewed paths ranked"
    - "Traffic sources panel shows referrer breakdown"
    - "Browser and device panels show visitor distribution"
    - "Web Vitals panels show Faro/Loki metrics"
  artifacts:
    - path: "chart/files/dashboards/blog-analytics.json"
      provides: "Dashboard JSON with all panels"
      contains: "schemaVersion"
    - path: "chart/templates/grafana-dashboard.yaml"
      provides: "ConfigMap template for sidecar discovery"
      contains: "grafana_dashboard"
    - path: "chart/values.yaml"
      provides: "Dashboard configuration toggle"
      contains: "dashboard:"
  key_links:
    - from: "chart/templates/grafana-dashboard.yaml"
      to: "chart/files/dashboards/blog-analytics.json"
      via: ".Files.Get"
      pattern: 'Files\.Get.*blog-analytics\.json'
    - from: "chart/templates/grafana-dashboard.yaml"
      to: "Grafana sidecar"
      via: "grafana_dashboard label"
      pattern: 'grafana_dashboard:\s*"1"'
---

<objective>
Create a GitOps-provisioned Grafana dashboard that visualizes blog analytics from Prometheus metrics (page views, traffic sources, device analytics) and Faro/Loki data (Web Vitals, sessions).

Purpose: Complete v1.1 milestone by providing actionable analytics visualization. Users can see traffic patterns, popular content, visitor distribution, and performance metrics in a single dashboard.

Output:
- Dashboard JSON file with all panels organized by user questions
- Helm ConfigMap template with sidecar discovery label
- Values.yaml additions for dashboard configuration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase research (dashboard patterns, queries, pitfalls)
@.planning/phases/10-grafana-dashboard/10-RESEARCH.md

# Phase context (locked decisions)
@.planning/phases/10-grafana-dashboard/10-CONTEXT.md

# Prior phase summaries (metric structure)
@.planning/phases/07-page-view-metrics/07-01-SUMMARY.md
@.planning/phases/08-traffic-source-attribution/08-01-SUMMARY.md
@.planning/phases/09-device-analytics/09-01-SUMMARY.md

# Existing Helm chart structure
@chart/values.yaml
@chart/templates/_helpers.tpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard JSON with all analytics panels</name>
  <files>chart/files/dashboards/blog-analytics.json</files>
  <action>
Create the dashboard JSON file following 10-RESEARCH.md patterns and 10-CONTEXT.md layout decisions:

**Root structure:**
- uid: "victorbona-blog-analytics"
- title: "victorbona.blog Analytics"
- schemaVersion: 42
- timezone: "browser"
- editable: false
- refresh: "30s"
- time: { from: "now-24h", to: "now" }

**Template variables (for portability):**
- `datasource`: type=datasource, query=prometheus
- `loki`: type=datasource, query=loki

**Panel layout (rows organized by user questions):**

Row 1: Summary Stats (y=0-4)
- Total Page Views (stat, w=6) - `sum(increase(blog_page_views_total{is_bot="false"}[$__range]))`
- Unique Sessions (stat, w=6) - Loki session count approximation
- Top Page (stat, w=6) - `topk(1, sum by (path) (increase(...)))`
- Avg Load Time (stat, w=6) - Faro LCP average

Row 2: Traffic Trends - "How much traffic?" (y=5-13)
- Page Views Over Time (timeseries, w=24) - `sum(rate(blog_page_views_total{is_bot="false"}[$__rate_interval])) * 60`

Row 3: Top Pages (y=14-21)
- Top Pages Ranking (table, w=24) - `topk(10, sum by (path) (increase(...)))` with transformations to rename columns

Row 4: Traffic Sources - "Where from?" (y=22-29)
- Traffic Sources (piechart, w=8) - `sum by (source) (increase(...))`
- UTM Sources (piechart, w=8) - `sum by (utm_source) (increase(...))` where utm_source != ""
- UTM Mediums (piechart, w=8) - `sum by (utm_medium) (increase(...))` where utm_medium != ""

Row 5: Devices - "What devices?" (y=30-37)
- Browsers (piechart, w=12) - `sum by (browser) (increase(...))`
- Devices (piechart, w=12) - `sum by (device) (increase(...))`

Row 6: Performance - "How fast?" (y=38-49)
- Web Vitals Health (stat, w=8) - Combined indicator (green/yellow/red based on thresholds)
- LCP (stat, w=4) - Loki query with 2500ms yellow, 4000ms red thresholds
- INP (stat, w=4) - Loki query with 200ms yellow, 500ms red thresholds
- CLS (stat, w=4) - Loki query with 0.1 yellow, 0.25 red thresholds
- JS Errors (stat, w=4) - Loki error count

**Critical patterns (from RESEARCH.md):**
- Use `$__range` for stat panels (totals over selected period)
- Use `$__rate_interval` for time series (auto-adjusting rate)
- Filter `{is_bot="false"}` to exclude bot traffic from human analytics
- Use `increase()` for totals, `rate() * 60` for per-minute in time series
- Pie charts: `reduceOptions.calcs: ["lastNotNull"]` with `values: false`
- Table: `instant: true` with `format: table` for ranking queries
- Rows with `collapsed: false` - panels at top-level with correct y positions

**Avoid anti-patterns:**
- No hardcoded datasource UIDs (use `${datasource}`, `${loki}`)
- No nested panels in non-collapsed rows
- No `rate()` in stat panels (use `increase()`)
  </action>
  <verify>
- `jq . chart/files/dashboards/blog-analytics.json` parses without errors
- JSON contains `schemaVersion: 42`
- JSON contains `grafana_dashboard` or datasource template variables
- JSON has 6 row panels and all visualization panels (stat, timeseries, table, piechart)
  </verify>
  <done>
Dashboard JSON file is valid, contains all panels described in CONTEXT.md layout, uses template variables for datasources, follows RESEARCH.md patterns for queries and panel configuration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Helm ConfigMap template and update values.yaml</name>
  <files>chart/templates/grafana-dashboard.yaml, chart/values.yaml</files>
  <action>
**Create chart/templates/grafana-dashboard.yaml:**

```yaml
{{- if .Values.observability.dashboard.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "app-template.fullname" . }}-grafana-dashboard
  namespace: {{ .Values.observability.dashboard.namespace | default .Release.Namespace }}
  labels:
    {{- include "app-template.commonLabels" . | nindent 4 }}
    grafana_dashboard: "1"
  {{- if .Values.observability.dashboard.folder }}
  annotations:
    grafana_folder: {{ .Values.observability.dashboard.folder | quote }}
  {{- end }}
data:
  victorbona-blog-dashboard.json: |-
{{ .Files.Get "files/dashboards/blog-analytics.json" | indent 4 }}
{{- end }}
```

Key elements:
- Conditional on `.Values.observability.dashboard.enabled`
- Uses existing `app-template.fullname` and `app-template.commonLabels` helpers
- Label `grafana_dashboard: "1"` (string "1", not integer) for sidecar discovery
- Optional `grafana_folder` annotation for Grafana folder placement
- Namespace configurable (default to release namespace)
- References dashboard JSON via `.Files.Get`

**Update chart/values.yaml:**

Add under existing `observability:` section (after `podMonitor:`):

```yaml
  dashboard:
    # Enabled in Phase 10 (Grafana Dashboard)
    enabled: true
    namespace: "observability-system"  # Namespace where Grafana sidecar watches
    folder: ""                         # Optional: target Grafana folder name
```

Ensure the directory `chart/files/dashboards/` exists for `.Files.Get` to work.
  </action>
  <verify>
- `helm template test ./chart` runs without errors
- Output contains ConfigMap with `grafana_dashboard: "1"` label
- Output contains the dashboard JSON content indented correctly
- values.yaml has `dashboard.enabled: true` under observability section
  </verify>
  <done>
Helm chart generates ConfigMap with correct sidecar label, dashboard JSON embedded, and values.yaml allows enabling/disabling dashboard provisioning. `helm template` produces valid YAML.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Lint Helm chart:**
   ```bash
   helm lint ./chart
   ```
   Should pass with no errors.

2. **Template rendering:**
   ```bash
   helm template victorbona-blog ./chart | grep -A 5 "grafana_dashboard"
   ```
   Should show ConfigMap with `grafana_dashboard: "1"` label.

3. **Dashboard JSON structure:**
   ```bash
   jq '.panels | length' chart/files/dashboards/blog-analytics.json
   ```
   Should return total panel count (rows + visualization panels).

4. **Verify datasource variables:**
   ```bash
   jq '.templating.list[].name' chart/files/dashboards/blog-analytics.json
   ```
   Should include "datasource" and "loki".
</verification>

<success_criteria>
- [ ] DASH-01: Dashboard JSON provisioned via ConfigMap in Helm chart
- [ ] DASH-02: Dashboard auto-discovered by Grafana sidecar with correct labels (`grafana_dashboard: "1"`)
- [ ] DASH-03: Page views over time panel with valid PromQL query
- [ ] DASH-04: Top pages table panel with `topk()` query
- [ ] DASH-05: Traffic sources pie chart with `sum by (source)` query
- [ ] DASH-06: Browser and device pie charts with correct label queries
- [ ] DASH-07: Unique sessions stat panel with Loki query
- [ ] DASH-08: Web Vitals panels (LCP, INP, CLS) with Loki queries and thresholds
- [ ] Helm lint passes
- [ ] Helm template renders valid YAML with ConfigMap
- [ ] Build verification (if applicable) passes
</success_criteria>

<output>
After completion, create `.planning/phases/10-grafana-dashboard/10-01-SUMMARY.md` following the summary template.

Include:
- All files created/modified
- Dashboard structure summary (panels, rows)
- PromQL and LogQL queries used
- Any deviations from plan
- Verification results
</output>
