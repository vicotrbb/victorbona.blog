---
phase: 04-server-side-tracing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - instrumentation.ts
  - chart/values.yaml
autonomous: true

# Approved deviation from REQ-OBS-002:
# Original: OTLP gRPC to port 4317
# Actual: OTLP HTTP/protobuf to port 4318
# Rationale: @grpc/grpc-js causes module resolution errors in Next.js bundling
#            (e.g., "Can't resolve 'stream'"). HTTP/protobuf is the standard
#            choice for Next.js OTEL integration. Alloy supports both protocols.
# Research: 04-RESEARCH.md "Key Decision: HTTP vs gRPC Protocol" section
# Requirements updated: 2026-01-27

must_haves:
  truths:
    - "Application starts with tracing enabled when OTEL_EXPORTER_OTLP_ENDPOINT is set"
    - "Application starts without tracing when OTEL_EXPORTER_OTLP_ENDPOINT is not set"
    - "Service name appears as 'victorbona-blog' in traces"
    - "10% of traces are sampled (head-based sampling)"
  artifacts:
    - path: "instrumentation.ts"
      provides: "OTEL SDK initialization"
      min_lines: 20
    - path: "package.json"
      provides: "OTEL dependencies"
      contains: "@vercel/otel"
    - path: "chart/values.yaml"
      provides: "OTEL environment variable configuration"
      contains: "OTEL_EXPORTER_OTLP_ENDPOINT"
  key_links:
    - from: "instrumentation.ts"
      to: "@vercel/otel"
      via: "registerOTel import"
      pattern: "import.*registerOTel.*@vercel/otel"
    - from: "instrumentation.ts"
      to: "environment variables"
      via: "process.env.OTEL_EXPORTER_OTLP_ENDPOINT"
      pattern: "process\\.env\\.OTEL_EXPORTER_OTLP_ENDPOINT"
    - from: "chart/values.yaml"
      to: "observability.otel"
      via: "enabled: true and endpoint config"
      pattern: "enabled:\\s*true"
    - from: "chart/templates/deployment.yaml"
      to: "chart/values.yaml"
      via: "env var rendering"
      pattern: "HOSTNAME.*0\\.0\\.0\\.0"
---

<objective>
Configure OpenTelemetry server-side tracing for the Next.js blog with export to Alloy via HTTP/protobuf.

Purpose: Enable distributed tracing to Tempo for request observability, error debugging, and performance analysis.

Output:
- instrumentation.ts with @vercel/otel configuration
- OTEL packages installed
- Helm values configured for OTEL environment variables
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-server-side-tracing/04-RESEARCH.md
@.planning/phases/04-server-side-tracing/04-CONTEXT.md

# Existing files to modify
@package.json
@chart/values.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install OTEL packages</name>
  <files>package.json</files>
  <action>
Install the required OpenTelemetry packages using npm:

```bash
npm install @vercel/otel @opentelemetry/sdk-logs @opentelemetry/api-logs @opentelemetry/instrumentation @opentelemetry/sdk-trace-node @opentelemetry/exporter-trace-otlp-http @opentelemetry/resources @opentelemetry/semantic-conventions
```

These packages provide:
- `@vercel/otel`: Next.js-optimized OTEL integration (handles Edge+Node runtimes)
- `@opentelemetry/sdk-trace-node`: Samplers (ParentBasedSampler, TraceIdRatioBasedSampler)
- `@opentelemetry/exporter-trace-otlp-http`: HTTP/protobuf exporter (NOT gRPC - gRPC has bundling issues with Next.js)
- Others: Required dependencies for @vercel/otel

Why HTTP not gRPC: `@grpc/grpc-js` causes module resolution errors in Next.js bundling. HTTP/protobuf to port 4318 is the reliable choice.
  </action>
  <verify>
Run `npm ls @vercel/otel` and confirm the package is listed.
Check package.json includes all OTEL dependencies.
  </verify>
  <done>
package.json contains @vercel/otel and related OTEL packages.
`npm ls @vercel/otel` shows package installed without peer dependency warnings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create instrumentation.ts</name>
  <files>instrumentation.ts</files>
  <action>
Create `instrumentation.ts` in the project root (NOT in app/ - Next.js requires it in root).

The file must:

1. Export a `register()` function (Next.js 15+ calls this automatically)
2. Skip initialization if `OTEL_EXPORTER_OTLP_ENDPOINT` is not set (allows local dev without tracing)
3. Use `@vercel/otel` registerOTel with custom configuration:
   - serviceName from `OTEL_SERVICE_NAME` env var, default "victorbona-blog"
   - service.version from `OTEL_SERVICE_VERSION` env var, default "unknown"
   - Custom `OTLPTraceExporter` to `${endpoint}/v1/traces` using HTTP/protobuf
   - `ParentBasedSampler` with `TraceIdRatioBasedSampler` at 10% (configurable via `OTEL_TRACES_SAMPLER_ARG`)

Implementation pattern from research:

```typescript
import { registerOTel } from '@vercel/otel'
import { TraceIdRatioBasedSampler, ParentBasedSampler } from '@opentelemetry/sdk-trace-node'
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http'

export function register() {
  const endpoint = process.env.OTEL_EXPORTER_OTLP_ENDPOINT
  if (!endpoint) {
    console.log('OTEL_EXPORTER_OTLP_ENDPOINT not set, skipping tracing')
    return
  }

  registerOTel({
    serviceName: process.env.OTEL_SERVICE_NAME || 'victorbona-blog',
    attributes: {
      'service.version': process.env.OTEL_SERVICE_VERSION || 'unknown',
    },
    traceExporter: new OTLPTraceExporter({
      url: `${endpoint}/v1/traces`,
    }),
    traceSampler: new ParentBasedSampler({
      root: new TraceIdRatioBasedSampler(
        parseFloat(process.env.OTEL_TRACES_SAMPLER_ARG || '0.1')
      ),
    }),
  })
}
```

Do NOT:
- Place file in app/ or pages/
- Use gRPC exporter
- Add experimental.instrumentationHook to next.config.mjs (not needed in Next.js 15+)
  </action>
  <verify>
Run `npm run build` to verify the build succeeds with instrumentation.ts.
Verify instrumentation.ts exists in project root with `ls instrumentation.ts`.
  </verify>
  <done>
instrumentation.ts exists in project root.
Build completes without errors.
File exports a register() function that conditionally initializes OTEL.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify existing env vars render and configure OTEL values</name>
  <files>chart/values.yaml</files>
  <action>
**Step 1: Pre-verification of existing env var rendering**

Before modifying values.yaml, verify the existing env vars (HOSTNAME, PORT, NODE_ENV) render correctly:

```bash
helm template ./chart | grep -A 10 "env:" | head -20
```

Expected output should show the HOSTNAME env var with value "0.0.0.0". This confirms the deployment template correctly renders env vars from values.yaml. If this fails, investigate the template before proceeding.

**Step 2: Update values.yaml for OTEL**

Update chart/values.yaml to enable OTEL and configure environment variables.

1. Update the `observability.otel` section:
   - Set `enabled: true`
   - Set `endpoint: "http://alloy.observability-system.svc.cluster.local:4318"` (HTTP port, not gRPC)
   - Set `samplingRatio: "0.1"` (10% sampling)

2. Add OTEL environment variables to `components.web.env` array:

```yaml
# OTEL configuration (Phase 4)
- name: OTEL_SERVICE_NAME
  value: "victorbona-blog"
- name: OTEL_SERVICE_VERSION
  value: "latest"  # Overridden by ArgoCD image tag parameter
- name: OTEL_EXPORTER_OTLP_ENDPOINT
  value: "http://alloy.observability-system.svc.cluster.local:4318"
- name: OTEL_EXPORTER_OTLP_PROTOCOL
  value: "http/protobuf"
- name: OTEL_TRACES_SAMPLER
  value: "parentbased_traceidratio"
- name: OTEL_TRACES_SAMPLER_ARG
  value: "0.1"
```

Note: Using port 4318 (HTTP/protobuf) instead of 4317 (gRPC) due to Next.js bundling issues with @grpc/grpc-js. This is an approved deviation from the original requirement - see frontmatter and REQUIREMENTS.md.
  </action>
  <verify>
Run `helm template ./chart` and verify:
- Existing env vars (HOSTNAME, PORT, NODE_ENV) still render correctly
- OTEL environment variables appear in the deployment manifest
- No Helm template errors

Specific check:
```bash
helm template ./chart | grep -E "(HOSTNAME|OTEL_EXPORTER_OTLP_ENDPOINT)" | head -4
```
Should show both HOSTNAME and OTEL_EXPORTER_OTLP_ENDPOINT with correct values.
  </verify>
  <done>
chart/values.yaml has observability.otel.enabled: true.
OTEL_EXPORTER_OTLP_ENDPOINT is set to Alloy HTTP endpoint (port 4318).
All required OTEL env vars are present in components.web.env.
`helm template ./chart` succeeds without errors.
Existing env vars (HOSTNAME, PORT, NODE_ENV) still render correctly.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Build verification:**
   ```bash
   npm run build
   ```
   Build should complete without errors or warnings related to OTEL.

2. **Local start verification (no OTEL endpoint):**
   ```bash
   npm run start
   ```
   Server should start and log "OTEL_EXPORTER_OTLP_ENDPOINT not set, skipping tracing" (or similar).
   Application should function normally without tracing.

3. **Helm template verification:**
   ```bash
   helm template ./chart | grep -A5 OTEL
   ```
   Should show all OTEL environment variables in deployment spec.

4. **File location verification:**
   ```bash
   ls -la instrumentation.ts
   ```
   File exists in project root (not in app/).

5. **Existing env var verification:**
   ```bash
   helm template ./chart | grep -B2 -A2 HOSTNAME
   ```
   HOSTNAME env var renders with value "0.0.0.0".
</verification>

<success_criteria>
- instrumentation.ts exists in project root with register() function
- package.json includes @vercel/otel and OTEL dependencies
- chart/values.yaml has OTEL enabled with HTTP endpoint to Alloy (port 4318)
- Build succeeds with `npm run build`
- Application starts without OTEL endpoint set (graceful skip)
- Helm template renders OTEL environment variables
- Helm template renders existing env vars (HOSTNAME, PORT, NODE_ENV) correctly
</success_criteria>

<output>
After completion, create `.planning/phases/04-server-side-tracing/04-01-SUMMARY.md`
</output>
