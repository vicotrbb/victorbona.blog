---
phase: 06-browser-rum
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - app/components/faro-init.tsx
  - app/layout.tsx
  - chart/values.yaml
autonomous: true

must_haves:
  truths:
    - "Faro initializes on production deployments"
    - "Faro respects Do Not Track browser setting"
    - "Faro does not initialize in local development (no NEXT_PUBLIC_FARO_URL)"
    - "Core Web Vitals (LCP, CLS, INP) are collected"
    - "JavaScript errors are tracked"
    - "Session tracking correlates events from same visit"
  artifacts:
    - path: "app/components/faro-init.tsx"
      provides: "Faro initialization client component"
      exports: ["FaroInit"]
      min_lines: 30
    - path: "app/layout.tsx"
      provides: "Root layout with FaroInit integration"
      contains: "FaroInit"
    - path: "chart/values.yaml"
      provides: "Faro endpoint configuration"
      contains: "NEXT_PUBLIC_FARO_URL"
    - path: "package.json"
      provides: "Faro SDK dependency"
      contains: "@grafana/faro-web-sdk"
  key_links:
    - from: "app/layout.tsx"
      to: "app/components/faro-init.tsx"
      via: "import and render FaroInit"
      pattern: "import.*FaroInit.*from"
    - from: "app/components/faro-init.tsx"
      to: "process.env.NEXT_PUBLIC_FARO_URL"
      via: "environment variable for endpoint"
      pattern: "process\\.env\\.NEXT_PUBLIC_FARO_URL"
---

<objective>
Integrate Grafana Faro Web SDK for browser Real User Monitoring (RUM).

Purpose: Enable client-side observability to collect Core Web Vitals (LCP, CLS, INP), JavaScript errors, and session tracking. This completes the browser observability layer for the Kubernetes-deployed blog.

Output: FaroInit client component integrated into root layout, with configurable endpoint via Helm values.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-browser-rum/06-RESEARCH.md
@.planning/phases/06-browser-rum/06-CONTEXT.md
@app/layout.tsx
@chart/values.yaml
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Faro SDK and create FaroInit component</name>
  <files>package.json, app/components/faro-init.tsx</files>
  <action>
1. Install @grafana/faro-web-sdk:
   ```bash
   npm install @grafana/faro-web-sdk
   ```

2. Create `app/components/faro-init.tsx` with the following implementation:
   - Add 'use client' directive (required for browser APIs)
   - Import faro, getWebInstrumentations, initializeFaro from @grafana/faro-web-sdk
   - Implement guards (in order):
     a. SSR guard: `if (typeof window === 'undefined') return null`
     b. Already initialized guard: `if (faro.api) return null`
     c. DNT guard: `if (navigator.doNotTrack === '1' || (window as any).doNotTrack === '1') return null`
     d. Production guard: `const faroUrl = process.env.NEXT_PUBLIC_FARO_URL; if (!faroUrl) return null`
   - Call initializeFaro with config:
     - url: faroUrl
     - app.name: 'victorbona-blog'
     - app.version: process.env.NEXT_PUBLIC_APP_VERSION || '1.0.0'
     - app.environment: process.env.NODE_ENV
     - instrumentations: [...getWebInstrumentations()]
     - sessionTracking.enabled: true
     - sessionTracking.persistent: true
   - Wrap in try/catch, log warning on failure: `console.warn('Faro initialization failed:', error)`
   - Return null (component renders nothing)
   - Export as named export: `export function FaroInit()`

Key patterns from research:
- getWebInstrumentations() includes WebVitals, Errors, Console, and Session instrumentations
- faro.api check prevents duplicate initialization during HMR
- DNT check per CONTEXT.md privacy decision
  </action>
  <verify>
1. npm install completes without errors
2. TypeScript compiles: `npx tsc --noEmit`
3. File exists at app/components/faro-init.tsx with 'use client' directive
  </verify>
  <done>
- @grafana/faro-web-sdk in package.json dependencies
- FaroInit component created with all guards (SSR, initialized, DNT, production)
- Component exports properly and TypeScript types are valid
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate FaroInit into layout and configure Helm values</name>
  <files>app/layout.tsx, chart/values.yaml</files>
  <action>
1. Modify `app/layout.tsx`:
   - Add import: `import { FaroInit } from './components/faro-init';`
   - Place `<FaroInit />` as the FIRST child in `<body>`, before other content
   - The layout remains a Server Component (no 'use client' directive)

   Example placement:
   ```tsx
   <body className="antialiased max-w-4xl mx-4 mt-8 lg:mx-auto">
     <FaroInit />
     <main className="flex-auto min-w-0 mt-6 flex flex-col px-4 md:px-6 lg:px-8">
       ...
     </main>
   </body>
   ```

2. Modify `chart/values.yaml`:
   - Add NEXT_PUBLIC_FARO_URL to components.web.env section
   - Add NEXT_PUBLIC_APP_VERSION to pass version to Faro

   Add these env vars after the existing OTEL vars:
   ```yaml
   # Faro RUM configuration (Phase 6)
   - name: NEXT_PUBLIC_FARO_URL
     value: "https://faro.bonalab.org/collect"
   - name: NEXT_PUBLIC_APP_VERSION
     value: "1.0.0"  # Overridden by ArgoCD image tag parameter
   ```

Note: NEXT_PUBLIC_ prefix is required - Next.js only exposes these to client bundles.
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Build succeeds: `npm run build`
3. Verify layout imports FaroInit: `grep -n "FaroInit" app/layout.tsx`
4. Verify Helm values contain Faro URL: `grep "FARO_URL" chart/values.yaml`
  </verify>
  <done>
- FaroInit rendered in root layout before main content
- Layout remains a Server Component (no 'use client')
- NEXT_PUBLIC_FARO_URL configured in Helm values
- NEXT_PUBLIC_APP_VERSION configured in Helm values
- Build completes successfully
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Dependency installed:** `npm list @grafana/faro-web-sdk` shows version
2. **Component exists:** `cat app/components/faro-init.tsx` shows FaroInit with guards
3. **Layout integration:** `grep FaroInit app/layout.tsx` shows import and usage
4. **Helm config:** `grep NEXT_PUBLIC_FARO app/layout.tsx` (for env usage) and `grep FARO chart/values.yaml`
5. **Build passes:** `npm run build` completes without errors

Local development verification (Faro should NOT initialize):
- Run `npm run dev`
- Open browser DevTools console
- Confirm NO Faro-related network requests (since NEXT_PUBLIC_FARO_URL is not set locally)
</verification>

<success_criteria>
- @grafana/faro-web-sdk is installed and in package.json
- FaroInit component exists with all required guards (SSR, initialized, DNT, production)
- FaroInit is integrated into root layout as first child of body
- Helm values include NEXT_PUBLIC_FARO_URL and NEXT_PUBLIC_APP_VERSION
- TypeScript compilation succeeds
- Production build completes successfully
- In local dev, Faro does not initialize (no console errors, no network requests)
</success_criteria>

<output>
After completion, create `.planning/phases/06-browser-rum/06-01-SUMMARY.md`
</output>
