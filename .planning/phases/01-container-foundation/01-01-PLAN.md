---
phase: 01-container-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.mjs
  - app/api/health/route.ts
  - app/api/ready/route.ts
  - .dockerignore
autonomous: true

must_haves:
  truths:
    - "Next.js builds with standalone output mode"
    - "GET /api/health returns 200 with JSON status"
    - "GET /api/ready returns 200 with JSON status"
    - "Docker build context excludes unnecessary files"
  artifacts:
    - path: "next.config.mjs"
      provides: "Standalone output configuration"
      contains: "output: 'standalone'"
    - path: "app/api/health/route.ts"
      provides: "Kubernetes liveness probe endpoint"
      exports: ["GET"]
    - path: "app/api/ready/route.ts"
      provides: "Kubernetes readiness probe endpoint"
      exports: ["GET"]
    - path: ".dockerignore"
      provides: "Docker build context exclusions"
      min_lines: 10
  key_links:
    - from: "next.config.mjs"
      to: ".next/standalone"
      via: "next build output"
      pattern: "output.*standalone"
---

<objective>
Configure Next.js for standalone Docker deployment and create Kubernetes health probe endpoints.

Purpose: Prepare the application for containerization by enabling standalone output mode and adding the health/readiness endpoints required by Kubernetes probes.

Output:
- Modified next.config.mjs with `output: 'standalone'`
- New /api/health endpoint (liveness probe)
- New /api/ready endpoint (readiness probe)
- New .dockerignore file
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-container-foundation/01-RESEARCH.md

# Existing files to modify
@next.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure standalone output and create .dockerignore</name>
  <files>next.config.mjs, .dockerignore</files>
  <action>
1. Modify next.config.mjs to add `output: 'standalone'` while preserving existing rewrites configuration:

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone',
  async rewrites() {
    return [
      {
        source: "/js/script.js",
        destination: "https://datafa.st/js/script.js",
      },
      {
        source: "/api/events",
        destination: "https://datafa.st/api/events",
      },
    ];
  },
};

export default nextConfig;
```

2. Create .dockerignore with standard exclusions:

```
Dockerfile
.dockerignore
node_modules
npm-debug.log
README.md
.next
.git
.env*
.planning
chart
.github
*.md
.gitignore
.vercel
```

This excludes build artifacts, development files, and planning documents from the Docker build context.
  </action>
  <verify>
- Run `npm run build` and verify `.next/standalone` directory is created
- Verify .dockerignore exists with correct patterns
  </verify>
  <done>
- next.config.mjs contains `output: 'standalone'`
- Build produces `.next/standalone/server.js`
- .dockerignore exists with all exclusion patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Create health probe endpoints</name>
  <files>app/api/health/route.ts, app/api/ready/route.ts</files>
  <action>
Create the app/api directory structure and health probe endpoints.

1. Create app/api/health/route.ts (liveness probe):

```typescript
export async function GET() {
  return Response.json({ status: 'ok' })
}
```

2. Create app/api/ready/route.ts (readiness probe):

```typescript
export async function GET() {
  return Response.json({ status: 'ok' })
}
```

Design decisions per CONTEXT.md:
- Simple endpoints returning `{"status": "ok"}`
- No internal details exposed
- No authentication (standard for K8s probes)
- Liveness only checks process is running
- Readiness identical to liveness (no external dependencies to check for this frontend app)
  </action>
  <verify>
- Run `npm run dev` and test endpoints:
  - `curl http://localhost:3000/api/health` returns `{"status":"ok"}`
  - `curl http://localhost:3000/api/ready` returns `{"status":"ok"}`
  </verify>
  <done>
- /api/health returns 200 with JSON `{"status":"ok"}`
- /api/ready returns 200 with JSON `{"status":"ok"}`
- Both endpoints work in dev mode
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes successfully
2. `.next/standalone` directory exists with `server.js`
3. `curl localhost:3000/api/health` returns `{"status":"ok"}` (in dev mode)
4. `curl localhost:3000/api/ready` returns `{"status":"ok"}` (in dev mode)
5. `.dockerignore` contains all required exclusion patterns
</verification>

<success_criteria>
- Next.js builds in standalone mode (`.next/standalone` directory created)
- Health endpoint responds at /api/health
- Ready endpoint responds at /api/ready
- .dockerignore excludes node_modules, .next, .git, .planning, chart, .env files
</success_criteria>

<output>
After completion, create `.planning/phases/01-container-foundation/01-01-SUMMARY.md`
</output>
