---
phase: 01-container-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - Dockerfile
  - package.json
autonomous: true

must_haves:
  truths:
    - "Docker image builds successfully"
    - "Container starts and serves traffic on port 3000"
    - "Health endpoints accessible in container"
    - "Container runs as non-root user"
    - "Container handles SIGTERM gracefully"
  artifacts:
    - path: "Dockerfile"
      provides: "Multi-stage Docker build"
      contains: "FROM node:22-alpine"
      min_lines: 30
    - path: "package.json"
      provides: "Sharp dependency for image optimization"
      contains: "sharp"
  key_links:
    - from: "Dockerfile"
      to: ".next/standalone"
      via: "COPY standalone output"
      pattern: "COPY.*standalone"
    - from: "Dockerfile"
      to: "server.js"
      via: "CMD directive"
      pattern: 'CMD.*node.*server.js'
---

<objective>
Create a production-ready multi-stage Dockerfile for the Next.js blog.

Purpose: Build an optimized Docker image that can be deployed to Kubernetes with proper signal handling, non-root execution, and image optimization support.

Output:
- Multi-stage Dockerfile based on official Next.js example
- Updated package.json with sharp dependency
- Working Docker image that passes health probes
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-container-foundation/01-RESEARCH.md
@.planning/phases/01-container-foundation/01-01-SUMMARY.md

# Files from previous plan
@next.config.mjs
@.dockerignore
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sharp dependency</name>
  <files>package.json</files>
  <action>
Add sharp to package.json dependencies for image optimization in standalone mode:

```bash
npm install sharp
```

Sharp is required for Next.js Image component optimization when running in standalone mode. Without it, image optimization will fail with an error.

Note: The project uses npm (has package-lock.json), so use npm not yarn/pnpm.
  </action>
  <verify>
- `npm ls sharp` shows sharp is installed
- `package.json` contains "sharp" in dependencies
  </verify>
  <done>
- sharp is listed in package.json dependencies
- npm install completed successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Create multi-stage Dockerfile</name>
  <files>Dockerfile</files>
  <action>
Create Dockerfile at project root based on official Next.js example with these requirements from CONTEXT.md and RESEARCH.md:

1. Base image: node:22-alpine
2. Multi-stage build: deps -> builder -> runner
3. Non-root user (nodejs:nextjs)
4. Direct node execution (not npm start) for SIGTERM handling
5. HOSTNAME=0.0.0.0 for Kubernetes networking
6. OCI standard labels
7. Port 3000 exposed

```dockerfile
# syntax=docker.io/docker/dockerfile:1

FROM node:22-alpine AS base

# Dependencies stage
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package.json package-lock.json* ./
RUN npm ci

# Builder stage
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build

# Runner stage (production)
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production

# Create non-root user
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# Copy public assets
COPY --from=builder /app/public ./public

# Copy standalone output
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# OCI standard labels
LABEL org.opencontainers.image.title="victorbona.blog"
LABEL org.opencontainers.image.description="Victor Bona's personal blog"
LABEL org.opencontainers.image.source="https://github.com/vicotrbb/victorbona.blog"

USER nextjs

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Use node directly for proper SIGTERM handling (not npm start)
CMD ["node", "server.js"]
```

Critical details:
- Use `node server.js` NOT `npm start` for SIGTERM signal forwarding
- Set HOSTNAME after PORT (Next.js reads both)
- Use --chown flag when copying to set ownership in one layer
- libc6-compat required for Alpine native module compatibility
  </action>
  <verify>
- Dockerfile exists at project root
- Contains all required stages (base, deps, builder, runner)
- Uses CMD ["node", "server.js"] not npm start
- Sets HOSTNAME="0.0.0.0"
- Creates non-root user
  </verify>
  <done>
- Dockerfile created with multi-stage build
- Uses node:22-alpine base
- Runs as non-root user (nextjs)
- Uses direct node execution for signal handling
  </done>
</task>

<task type="auto">
  <name>Task 3: Build and test Docker image locally</name>
  <files></files>
  <action>
Build the Docker image and verify it works:

```bash
# Build the image
docker build -t victorbona-blog:test .

# Run the container
docker run -d -p 3000:3000 --name blog-test victorbona-blog:test

# Wait for startup (5 seconds should be enough)
sleep 5

# Test health endpoints
curl -s http://localhost:3000/api/health
curl -s http://localhost:3000/api/ready

# Test the main page loads
curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/

# Check container is running as non-root
docker exec blog-test whoami

# Test graceful shutdown (should complete quickly, not timeout)
time docker stop blog-test

# Cleanup
docker rm blog-test
docker rmi victorbona-blog:test
```

Expected results:
- Build completes without errors
- Health endpoints return `{"status":"ok"}`
- Main page returns 200
- `whoami` returns "nextjs"
- Stop completes in <5 seconds (graceful SIGTERM handling)
  </action>
  <verify>
- Docker build succeeds
- Container starts and responds on port 3000
- /api/health returns {"status":"ok"}
- /api/ready returns {"status":"ok"}
- Container runs as user "nextjs"
- Container stops gracefully (not killed after 30s timeout)
  </verify>
  <done>
- Docker image builds successfully
- Container serves traffic on port 3000
- Health probes work
- Runs as non-root user
- Handles SIGTERM gracefully
  </done>
</task>

</tasks>

<verification>
1. `docker build -t victorbona-blog:test .` succeeds
2. Container starts: `docker run -d -p 3000:3000 victorbona-blog:test`
3. Health check passes: `curl localhost:3000/api/health` returns `{"status":"ok"}`
4. Ready check passes: `curl localhost:3000/api/ready` returns `{"status":"ok"}`
5. Main page loads: `curl -I localhost:3000` returns 200
6. Non-root user: `docker exec <container> whoami` returns "nextjs"
7. Graceful shutdown: `docker stop <container>` completes in <10 seconds
</verification>

<success_criteria>
- Docker image builds successfully with multi-stage Dockerfile
- Image size is reasonable (<300MB, ideally <200MB)
- Container runs as non-root user "nextjs"
- Health endpoints accessible at /api/health and /api/ready
- Container handles SIGTERM gracefully (stops in <10s)
- Main blog page loads correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-container-foundation/01-02-SUMMARY.md`
</output>
