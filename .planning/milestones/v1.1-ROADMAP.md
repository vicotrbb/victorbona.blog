# Milestone v1.1: Analytics & Dashboard

**Status:** ✅ SHIPPED 2026-01-28
**Phases:** 7-10
**Total Plans:** 4

## Overview

Full observability with actionable page analytics and a unified Grafana dashboard combining Prometheus metrics with Faro browser RUM data.

## Phases

### Phase 7: Page View Metrics

**Goal**: Server-side page view tracking with normalized paths and request metadata
**Depends on**: Phase 6 (existing /metrics endpoint with prom-client)
**Plans**: 1 plan

Plans:
- [x] 07-01: Extend metrics, create middleware, track 404s

**Details:**
- `blog_page_views_total` Counter with path/method/is_bot/content_type labels
- `blog_http_requests_total` Counter for HTTP status code tracking
- `blog_page_duration_seconds` Histogram for request timing
- Header-passing pattern for Edge-to-Node.js compatibility
- Bot detection using isbot library

### Phase 8: Traffic Source Attribution

**Goal**: Traffic source categorization from referrer headers and UTM parameters
**Depends on**: Phase 7 (middleware skeleton exists)
**Plans**: 1 plan

Plans:
- [x] 08-01: Create source/UTM utilities, extend metrics labels, wire middleware

**Details:**
- detectSource function mapping domains to sources (google, twitter, etc.)
- extractUtmParams function with 50-char validation
- Extended blog_page_views_total with source/utm_source/utm_medium labels
- Self-referral detection (own domain → direct)

### Phase 9: Device Analytics

**Goal**: User-Agent parsing into browser and device categories using bowser
**Depends on**: Phase 7 (middleware skeleton exists)
**Plans**: 1 plan

Plans:
- [x] 09-01: Install bowser, create device-detection utility, extend metrics with browser/device labels

**Details:**
- detectBrowserAndDevice function using bowser library
- Browser normalization map (mobile safari → safari, chromium → chrome)
- Extended blog_page_views_total with browser/device labels
- Graceful handling of null/empty User-Agent strings

### Phase 10: Grafana Dashboard

**Goal**: GitOps-provisioned Grafana dashboard combining Prometheus metrics and Faro data
**Depends on**: Phases 7, 8, 9 (all metrics must exist before dashboard queries them)
**Plans**: 1 plan

Plans:
- [x] 10-01: Create dashboard JSON, Helm ConfigMap template, and values.yaml config

**Details:**
- Complete 22-panel dashboard (6 rows, 16 visualizations)
- Summary stats: Total views, unique sessions, top page, avg LCP
- Traffic trends: Page views over time timeseries
- Top pages: Ranking table with topk() query
- Traffic sources: Referrer, UTM source, UTM medium pie charts
- Devices: Browser and device distribution pie charts
- Performance: Web Vitals (LCP, INP, CLS) with thresholds, JS errors

---

## Milestone Summary

**Key Decisions:**
- 07-01-D1: Header-passing pattern for Edge-to-Node.js metric collection (prom-client requires Node.js)
- 07-01-D2: isbot library for bot detection (reliable, well-maintained)
- 07-01-D3: Keep actual paths in labels (limited posts, cardinality acceptable)
- 08-01-D1: Map domains to source identifiers (google, twitter) not categories
- 08-01-D2: Unknown referrers return domain as-is for maximum visibility
- 08-01-D3: UTM validation (50-char, alphanumeric) to prevent cardinality explosion
- 09-01-D1: Normalize browser names via map to reduce cardinality
- 09-01-D2: bowser library for UA parsing (handles Chromium variants correctly)
- 10-01-D1: Schema version 42 for Grafana dashboard
- 10-01-D2: Template variables for datasource portability
- 10-01-D3: Row sections organized by user questions

**Issues Resolved:**
- Edge/Node runtime incompatibility solved with header-passing pattern
- Cardinality control via validation and normalization

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- 404 counter may overcount due to Next.js App Router pre-rendering not-found boundary
- Image size 381MB (target was <300MB) - Sharp native binaries (from v1.0)
- @vercel/analytics still loaded alongside Faro RUM (from v1.0)

---

*For current project status, see .planning/ROADMAP.md*
