# Milestone v1.0: Production Deployment

**Status:** SHIPPED 2026-01-28
**Phases:** 1-6
**Total Plans:** 7

## Overview

Migrate the Next.js blog from Vercel to a self-hosted Kubernetes cluster with full observability integration. The milestone follows a dependency-driven sequence: containerization -> CI/CD -> deployment -> observability -> automation.

## Phases

### Phase 1: Container Foundation

**Goal**: Create a production-ready Docker image for the Next.js blog
**Depends on**: None (first phase)
**Plans**: 2 plans

Plans:
- [x] 01-01-PLAN.md - Configure standalone output and health endpoints
- [x] 01-02-PLAN.md - Create Dockerfile and verify build

**Details:**
- Multi-stage Dockerfile with standalone output
- next.config.mjs with `output: 'standalone'`
- Health endpoint at `/api/health`
- Readiness endpoint at `/api/ready`

**Requirements Addressed:**
- REQ-INF-001: Docker Image
- REQ-INF-002: Health Endpoints

**Key Files:**
- `Dockerfile` (new)
- `next.config.mjs` (modify)
- `app/api/health/route.ts` (new)
- `app/api/ready/route.ts` (new)
- `.dockerignore` (new)

---

### Phase 2: CI/CD Pipeline

**Goal**: Automate Docker image builds and push to GHCR
**Depends on**: Phase 1
**Plans**: 1 plan

Plans:
- [x] 02-01-PLAN.md - Create GitHub Actions workflow for multi-arch Docker builds

**Details:**
- GitHub Actions workflow for Docker builds
- Multi-architecture support (amd64, arm64)
- Automatic tagging with git SHA and `latest`
- Push to `ghcr.io/vicotrbb/victorbona.blog`

**Requirements Addressed:**
- REQ-INF-003: GitHub Actions CI/CD

**Key Files:**
- `.github/workflows/build.yml` (new)

---

### Phase 3: Helm Chart & Deployment

**Goal**: Configure Helm chart for ArgoCD deployment
**Depends on**: Phase 2
**Plans**: 1 plan

Plans:
- [x] 03-01-PLAN.md - Configure Helm chart for blog deployment

**Details:**
- Customized values.yaml for blog deployment
- ClusterIP service configuration
- Resource limits and requests
- Health probe configuration
- Observability environment variables (placeholders)

**Requirements Addressed:**
- REQ-INF-004: Helm Chart Customization
- REQ-INF-005: Cloudflare Tunnel Ingress

**Key Files:**
- `chart/Chart.yaml` (modify)
- `chart/values.yaml` (modify)

---

### Phase 4: Server-Side Tracing

**Goal**: Enable OpenTelemetry traces to Tempo via Alloy
**Depends on**: Phase 3
**Plans**: 1 plan

Plans:
- [x] 04-01-PLAN.md - Configure OTEL instrumentation and Helm values

**Details:**
- instrumentation.ts with OTEL SDK configuration
- OTLP HTTP exporter to Alloy (port 4318)
- Service name and version in spans
- 10% head-based sampling
- Helm values for OTEL configuration

**Requirements Addressed:**
- REQ-OBS-002: Server-Side Tracing

**Key Files:**
- `instrumentation.ts` (new, project root)
- `package.json` (add @vercel/otel, OTEL packages)
- `chart/values.yaml` (add OTEL env vars)

---

### Phase 5: Prometheus Metrics

**Goal**: Expose metrics endpoint for Prometheus scraping
**Depends on**: Phase 3
**Plans**: 1 plan

Plans:
- [x] 05-01-PLAN.md - Create metrics endpoint and enable ServiceMonitor

**Details:**
- /metrics route with prom-client
- Default Node.js runtime metrics (heap, event loop, GC)
- ServiceMonitor enabled in Helm chart

**Requirements Addressed:**
- REQ-OBS-003: Prometheus Metrics

**Key Files:**
- `app/lib/metrics.ts` (new)
- `app/metrics/route.ts` (new)
- `package.json` (add prom-client)
- `chart/values.yaml` (enable ServiceMonitor)

---

### Phase 6: Browser RUM (Faro)

**Goal**: Enable client-side observability with Grafana Faro
**Depends on**: Phase 3
**Plans**: 1 plan

Plans:
- [x] 06-01-PLAN.md - Integrate Faro SDK for browser RUM

**Details:**
- FaroInit client component
- Core Web Vitals collection (LCP, CLS, INP)
- JavaScript error tracking
- Helm values for Faro endpoint

**Requirements Addressed:**
- REQ-OBS-004: Browser RUM (Faro)

**Key Files:**
- `app/components/faro-init.tsx` (new)
- `app/layout.tsx` (add FaroInit)
- `package.json` (add @grafana/faro-web-sdk)
- `chart/values.yaml` (add Faro endpoint)

---

## Milestone Summary

**Decimal Phases:**
- None (sequential phases only)

**Key Decisions:**
- Use node:22-alpine as base image for smaller footprint
- HTTP/protobuf OTEL export to port 4318 (gRPC causes bundling errors)
- CPU-based HPA only (memory OOMKills are abrupt, not graceful)
- globalThis singleton for metrics registry (HMR resilience)
- DNT guard for Faro (privacy compliance)
- FaroInit first in body (earliest initialization)

**Issues Resolved:**
- SWC binary installation issue (clean npm install)
- OTEL gRPC bundling errors (switched to HTTP/protobuf)
- Metrics registry duplication during HMR (globalThis singleton)

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- Image size 381MB (target was <300MB) - Sharp native binaries
- @vercel/analytics still loaded alongside Faro RUM

---

_For current project status, see .planning/ROADMAP.md_
_Archived: 2026-01-28 as part of v1.0 milestone completion_
