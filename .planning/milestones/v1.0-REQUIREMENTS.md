# Requirements Archive: v1.0 Production Deployment

**Archived:** 2026-01-28
**Status:** SHIPPED

This is the archived requirements specification for v1.0.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

# Requirements

**Project:** victorbona.blog Kubernetes Migration
**Version:** v1.0
**Created:** 2026-01-26

## Overview

This document captures scoped requirements for migrating the blog from Vercel to a self-hosted Kubernetes cluster with full observability integration.

---

## Infrastructure Requirements

### REQ-INF-001: Docker Image
**Priority:** Must Have
**Category:** Container Foundation
**Status:** [x] Complete (Phase 1)

The blog must be containerized using an optimized multi-stage Docker build:
- Base: `node:22-alpine` for build stage
- Runner: Minimal production image with standalone output
- HOSTNAME=0.0.0.0 for Kubernetes networking
- Signal handling via direct `node server.js` (not npm)
- Image size target: <150MB

**Outcome:** Delivered. Image size 381MB (higher due to Sharp binaries).

### REQ-INF-002: Health Endpoints
**Priority:** Must Have
**Category:** Container Foundation
**Status:** [x] Complete (Phase 1)

Kubernetes-compatible health endpoints:
- `/api/health` - Liveness probe (returns 200 if process running)
- `/api/ready` - Readiness probe (returns 200 when ready to serve traffic)

**Outcome:** Delivered as specified.

### REQ-INF-003: GitHub Actions CI/CD
**Priority:** Must Have
**Category:** CI/CD Pipeline
**Status:** [x] Complete (Phase 2)

Automated build pipeline:
- Trigger on push to main branch
- Multi-architecture builds (amd64, arm64)
- Push to GHCR at `ghcr.io/vicotrbb/victorbona.blog`
- Tag with git SHA and `latest`

**Outcome:** Delivered as specified.

### REQ-INF-004: Helm Chart Customization
**Priority:** Must Have
**Category:** Deployment
**Status:** [x] Complete (Phase 3)

Customize existing Helm chart at `/chart`:
- Single-service blog deployment
- Configurable image repository and tag
- Resource limits and requests
- All observability settings via values.yaml

**Outcome:** Delivered with HPA, PDB, and full security context.

### REQ-INF-005: Cloudflare Tunnel Ingress
**Priority:** Must Have
**Category:** Deployment
**Status:** [x] Complete (Phase 3)

Ingress configuration for Cloudflare Tunnel:
- Support both `victorbona.dev` and `blog.victorbona.dev` domains
- No TLS configuration (handled by Cloudflare)
- ClusterIP service (no LoadBalancer/NodePort needed)

**Outcome:** Delivered. Ingress disabled, ClusterIP service.

---

## Observability Requirements

### REQ-OBS-001: Structured Logging
**Priority:** Must Have
**Category:** Observability
**Status:** [x] Complete (implicit)

JSON-formatted logs for Loki ingestion:
- Logs to stdout (auto-collected by Alloy DaemonSet)
- Include request context where available
- No custom log configuration needed (Alloy handles collection)

**Outcome:** Delivered via existing Alloy DaemonSet configuration.

### REQ-OBS-002: Server-Side Tracing
**Priority:** Must Have
**Category:** Observability
**Status:** [x] Complete (Phase 4)

OpenTelemetry traces to Tempo:
- Use `@vercel/otel` for Next.js integration
- Export via OTLP HTTP/protobuf to `alloy.observability-system.svc.cluster.local:4318`
- Service name and version in all spans
- Configurable endpoint via Helm values

**Deviation (2026-01-27):** Originally specified gRPC port 4317, changed to HTTP/protobuf port 4318 due to `@grpc/grpc-js` module resolution errors in Next.js bundling. HTTP/protobuf is the standard choice for Next.js OTEL integration. See 04-RESEARCH.md for details.

**Outcome:** Delivered with HTTP/protobuf exporter.

### REQ-OBS-003: Prometheus Metrics
**Priority:** Must Have
**Category:** Observability
**Status:** [x] Complete (Phase 5)

Metrics endpoint for Prometheus scraping:
- `/metrics` route exposing prom-client metrics
- Default Node.js runtime metrics (memory, event loop, GC)
- ServiceMonitor enabled in Helm chart
- Configurable scrape interval

**Deviation (2026-01-27):** Originally specified `/api/metrics` path, implemented as `/metrics` to match existing values.yaml configuration and Prometheus conventions.

**Outcome:** Delivered at /metrics with ServiceMonitor.

### REQ-OBS-004: Browser RUM (Faro)
**Priority:** Should Have
**Category:** Observability
**Status:** [x] Complete (Phase 6)

Grafana Faro for Real User Monitoring:
- Core Web Vitals (LCP, CLS, INP)
- JavaScript error tracking
- Export to `faro.bonalab.org`
- Configurable endpoint via Helm values
- Client-side initialization in root layout

**Outcome:** Delivered with privacy guards (DNT compliance).

---

## Automation Requirements

### REQ-AUTO-001: Renovate Configuration
**Priority:** Should Have
**Category:** Automation
**Status:** [ ] Out of Scope

Automated dependency updates:
- renovate.json in repository root
- ArgoCD file pattern recognition (`chart/**`)
- Pin canary/alpha dependencies (no auto-merge)
- Group minor/patch updates
- Auto-merge for non-breaking patches

**Outcome:** Explicitly removed from v1.0 scope. Phase 7 deleted from roadmap.

---

## Out of Scope (v1)

The following are explicitly deferred:

- **Frontend-backend trace correlation** - High complexity, defer to v2
- **Custom business metrics** - Not needed for personal blog
- **100% trace sampling** - Use probabilistic sampling
- **Real-time alerting** - Monitor dashboards sufficient for v1
- **User session recording** - Privacy concerns, not needed
- **APM SaaS integration** - Using self-hosted stack only
- **Multi-replica scaling** - Single replica sufficient
- **Database integration** - Blog is static, no database needed

---

## Acceptance Criteria

### Deployment Success
- [x] Docker image builds successfully via GitHub Actions
- [x] Image pushed to GHCR with correct tags
- [x] ArgoCD syncs and deploys to cluster
- [ ] Blog accessible at victorbona.dev and blog.victorbona.dev (manual verification)
- [x] Health probes pass (liveness and readiness)

### Observability Success
- [ ] Traces visible in Grafana Tempo (manual verification)
- [ ] Logs visible in Grafana Loki (manual verification)
- [x] Metrics scrapable at /metrics
- [x] ServiceMonitor working with Prometheus
- [ ] Faro RUM data in Grafana (manual verification)

### Automation Success
- [ ] Renovate creates PRs for dependency updates (out of scope for v1)
- [ ] ArgoCD file changes detected by Renovate (out of scope for v1)

---

## Milestone Summary

**Shipped:** 8 of 9 v1 requirements
**Adjusted:**
- REQ-OBS-002: gRPC -> HTTP/protobuf (bundling compatibility)
- REQ-OBS-003: /api/metrics -> /metrics (convention alignment)
**Dropped:**
- REQ-AUTO-001: Renovate (explicitly removed from scope)

---
*Archived: 2026-01-28 as part of v1.0 milestone completion*
